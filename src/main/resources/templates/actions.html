<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr" x-data="actionsComponent()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mes Actions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">

    <div class="mb-4">
        <button class="btn btn-secondary" @click="goBackToAccounts()">← Retour aux comptes</button>
    </div>

    <!-- Formulaire de création -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Créer une nouvelle action</h5>
            <form class="row g-3" @submit.prevent="createAction()">
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Symbole" x-model="newAction.symbol" required>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Nom" x-model="newAction.nom" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" placeholder="Prix" x-model="newAction.prix" step="0.01" required>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-success">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tableau des actions -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">Liste des actions</h5>
            <div class="table-responsive" style="max-height:400px; overflow-y:auto;">
                <table class="table table-striped table-hover">
                    <thead class="table-primary">
                    <tr>
                        <th>Symbole</th>
                        <th>Nom</th>
                        <th>Prix (€)</th>
                    </tr>
                    </thead>
                    <tbody>
                    <template x-for="a in actions" :key="a.id">
                        <tr>
                            <td x-text="a.symbol"></td>
                            <td x-text="a.nom"></td>
                            <td x-text="Number(a.prix).toFixed(2) + ' €'"></td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
<script>
    function actionsComponent() {
        return {
            actions: [],
            newAction: { symbol: '', nom: '', prix: '' },

            // Charger les actions existantes
            loadActions() {
                const token = localStorage.getItem('jwt');
                const clientId = localStorage.getItem('clientId');
                if (!token || !clientId) return;

                fetch('/api/actions/courant', {
                    headers: { "Authorization": "Bearer " + token }
                })
                    .then(res => res.json())
                    .then(data => this.actions = data)
                    .catch(err => console.error("Erreur lors du chargement des actions :", err));
            },

            // Créer une nouvelle action
            createAction() {
                const token = localStorage.getItem('jwt');
                const clientId = localStorage.getItem('clientId');
                if (!token || !clientId) {
                    alert("Vous devez être connecté pour créer une action !");
                    return;
                }

                const actionPayload = {
                    clientId: clientId,
                    symbol: this.newAction.symbol,
                    nom: this.newAction.nom,
                    prix: Number(this.newAction.prix)
                };

                fetch('/api/actions', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(actionPayload)
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Erreur lors de la création de l'action");
                        return res.json();
                    })
                    .then(action => {
                        this.actions.push(action);
                        this.newAction = { symbol: '', nom: '', prix: '' };
                    })
                    .catch(err => {
                        console.error("Impossible de créer l'action :", err);
                        alert("Impossible de créer l'action : " + err.message);
                    });
            },

            // Retour aux comptes correct
            goBackToAccounts() {
                const token = localStorage.getItem('jwt');
                const clientId = localStorage.getItem('clientId');
                if (!token || !clientId) {
                    alert("Vous devez être connecté !");
                    return;
                }

                // Le JWT reste dans localStorage pour l'authentification
                localStorage.setItem('jwt', token);

                // Redirection vers la route correcte du client
                window.location.href = `/clients/${clientId}/compteClient`;
            },

            init() {
                this.loadActions();
            }
        }
    }
</script>

</body>
</html>
