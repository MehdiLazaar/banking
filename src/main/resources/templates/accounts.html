<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr" x-data="accountManager()">
<head>
    <meta charset="UTF-8">
    <title>Comptes du client</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>

<div class="container mt-5">

    <!-- Bouton déconnexion -->
    <button class="btn btn-danger mb-4" @click="logout()">Déconnexion</button>

    <!-- Titres -->
    <h2 class="text-primary fw-bold">Comptes du client</h2>
    <h4 class="mb-4" th:text="${client.firstName + ' ' + client.lastName}"></h4>

    <!-- Tableau des comptes -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-bordered align-middle" id="accounts-table">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Nom</th>
                <th>Solde (€)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="acc : ${accounts}" :key="[[${acc.id}]]">
                <td th:text="${acc.id}"></td>
                <td th:text="${acc.type}"></td>
                <td th:text="${acc.nom}"></td>
                <td th:text="${acc.balance}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${#lists.isEmpty(accounts)}" class="alert alert-info mt-3 shadow-sm">
        Aucun compte trouvé pour ce client.
    </div>

    <!-- Formulaire création compte -->
    <div class="card mt-5 shadow-sm">
        <div class="card-body">
            <h4 class="card-title mb-4">Créer un nouveau compte</h4>
            <form @submit.prevent="createAccount">
                <div class="mb-3">
                    <label class="form-label">Type :</label>
                    <select class="form-select" x-model="newAccount.type" required>
                        <option value="">--Choisir--</option>
                        <option value="COURANT">COURANT</option>
                        <option value="LIVRET_A">LIVRET A</option>
                        <option value="PEA">PEA</option>
                        <option value="PEL">PEL</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Nom :</label>
                    <input class="form-control" type="text" x-model="newAccount.nom" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">Solde (€) :</label>
                    <input class="form-control" type="number" x-model="newAccount.balance" step="0.01" required>
                </div>

                <button type="submit" class="btn btn-success w-100 fw-bold">Créer le compte</button>
            </form>
        </div>
    </div>

    <!-- Bouton pour créer une action -->
    <div class="mt-4">
        <button class="btn btn-primary w-100 fw-bold" @click="goToActions()">Créer mon action</button>
    </div>

</div>

<script>
    function accountManager() {
        return {
            clientId: "[[${client.id}]]",
            newAccount: {
                type: '',
                nom: "[[${client.firstName + ' ' + client.lastName}]]",
                balance: null
            },

            // Création compte
            createAccount() {
                if (!this.newAccount.type || this.newAccount.balance === null) {
                    alert("Veuillez remplir tous les champs obligatoires !");
                    return;
                }
                if (!Auth.token) {
                    alert("Vous devez être connecté pour créer un compte !");
                    return;
                }

                fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + Auth.token
                    },
                    body: JSON.stringify({
                        client_id: this.clientId,
                        type: this.newAccount.type,
                        nom: this.newAccount.nom,
                        balance: this.newAccount.balance
                    })
                })
                    .then(res => res.json())
                    .then(account => {
                        const tbody = document.querySelector('#accounts-table tbody');
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${account.id}</td>
                                     <td>${account.type}</td>
                                     <td>${account.nom}</td>
                                     <td>${account.balance}</td>`;
                        tbody.appendChild(row);

                        this.newAccount.type = '';
                        this.newAccount.balance = null;
                    })
                    .catch(err => {
                        console.error("Erreur lors de la création du compte :", err);
                        alert("Erreur lors de la création du compte : " + (err.message || JSON.stringify(err)));
                    });
            },

            // Déconnexion
            logout() {
                Auth.logout();
            },

            // Redirection vers /actions/courant pour créer une action
            goToActions() {
                const token = localStorage.getItem('jwt');
                if (!token) {
                    alert("Vous devez être connecté pour créer une action !");
                    return;
                }

                fetch('/api/actions/courant', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Non autorisé ou problème serveur");
                        return res.json();
                    })
                    .then(actions => {
                        localStorage.setItem('myActions', JSON.stringify(actions));
                        window.location.href = '/actions';
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Impossible de récupérer vos actions : " + err.message);
                    });
            }

        }
    }
</script>

</body>
</html>
