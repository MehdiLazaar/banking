<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr" x-data="accountManager()">
<head>
    <meta charset="UTF-8">
    <title>Comptes et Actions du client</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        table { max-height: 300px; overflow-y: auto; display: block; }
        .table tbody { display: block; max-height: 250px; overflow-y: auto; }
        .table thead, .table tbody tr { display: table; width: 100%; table-layout: fixed; }
    </style>
</head>
<body class="bg-light" x-init="init()">

<div class="container py-5">

    <!-- Déconnexion -->
    <div class="d-flex justify-content-end mb-4">
        <button class="btn btn-danger" @click="logout()">Déconnexion</button>
    </div>

    <h2 class="text-primary fw-bold">Comptes du client</h2>
    <h4 class="mb-4" th:text="${client.firstName + ' ' + client.lastName}"></h4>

    <!-- Tableau des comptes -->
    <div class="table-responsive shadow-sm rounded mb-4">
        <table class="table table-striped table-bordered align-middle" id="accounts-table">
            <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Nom</th>
                <th>Solde (€)</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="acc : ${accounts}" :key="[[${acc.id}]]">
                <td th:text="${acc.id}"></td>
                <td th:text="${acc.type}"></td>
                <td th:text="${acc.nom}"></td>
                <td th:text="${acc.balance}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Tableau des actions du client connecté -->
    <h4 class="text-primary fw-bold mb-2">Actions créées par ce client</h4>
    <div class="table-responsive shadow-sm rounded mb-4">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-primary">
            <tr>
                <th>Symbole</th>
                <th>Nom</th>
                <th>Prix (€)</th>
            </tr>
            </thead>
            <tbody>
            <template x-for="a in actions" :key="a.id">
                <tr>
                    <td x-text="a.symbol"></td>
                    <td x-text="a.nom"></td>
                    <td x-text="a.prix + ' €'"></td>
                </tr>
            </template>
            </tbody>
        </table>
    </div>

    <!-- Formulaire création compte -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-4">Créer un nouveau compte</h5>
            <form @submit.prevent="createAccount">
                <div class="mb-3">
                    <label class="form-label">Type :</label>
                    <select class="form-select" x-model="newAccount.type" required>
                        <option value="">--Choisir--</option>
                        <option value="COURANT">COURANT</option>
                        <option value="LIVRET_A">LIVRET A</option>
                        <option value="PEA">PEA</option>
                        <option value="PEL">PEL</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nom :</label>
                    <input class="form-control" type="text" x-model="newAccount.nom" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Solde (€) :</label>
                    <input class="form-control" type="number" x-model="newAccount.balance" step="0.01" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Créer le compte</button>
            </form>
        </div>
    </div>

    <!-- Bouton pour créer une action -->
    <div class="d-grid">
        <button class="btn btn-primary" @click="goToActions()">Créer mon action</button>
    </div>

</div>

<script>
    function accountManager() {
        return {
            clientId: "[[${client.id}]]",
            actions: [],
            newAccount: { type: '', nom: "[[${client.firstName + ' ' + client.lastName}]]", balance: null },

            init() {
                this.loadActions();
            },

            loadActions() {
                const token = localStorage.getItem('jwt');
                if (!token) return;
                fetch('/api/actions/courant', {
                    headers: { "Authorization": "Bearer " + token }
                })
                    .then(res => res.json())
                    .then(data => this.actions = data)
                    .catch(err => console.error("Erreur lors du chargement des actions :", err));
            },

            createAccount() {
                if (!this.newAccount.type || this.newAccount.balance === null) {
                    alert("Veuillez remplir tous les champs !");
                    return;
                }

                const token = localStorage.getItem('jwt'); // récupérer le JWT stocké
                if (!token) {
                    alert("Vous devez être connecté !");
                    return;
                }

                fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        client_id: this.clientId,
                        type: this.newAccount.type,
                        nom: this.newAccount.nom,
                        balance: Number(this.newAccount.balance)
                    })
                })
                    .then(res => {
                        if (!res.ok) throw new Error("Erreur serveur lors de la création du compte");
                        return res.json();
                    })
                    .then(account => {
                        const tbody = document.querySelector('#accounts-table tbody');
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${account.id}</td><td>${account.type}</td><td>${account.nom}</td><td>${account.balance}</td>`;
                        tbody.appendChild(row);

                        this.newAccount.type = '';
                        this.newAccount.balance = null;
                    })
                    .catch(err => alert("Erreur lors de la création du compte : " + err.message));
            },

            goToActions() {
                const token = localStorage.getItem('jwt');
                if (!token) return alert("Vous devez être connecté !");
                window.location.href = '/actions';
            },

            logout() {
                // Supprime le JWT stocké
                localStorage.removeItem('jwt');
                // Supprime les actions stockées
                localStorage.removeItem('myActions');
                // Redirection vers la page de login ou accueil
                window.location.href = '/login'; // ou '/' selon ton application
            }

        }
    }
</script>

</body>
</html>
